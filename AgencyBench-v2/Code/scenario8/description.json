{
    "subtask_count": 5,
    "subtask1": "Query:\n**Subtask 1: FastAPI Application and MongoDB Connection Setup**\n\nSet up the foundational web application and database connectivity:\n\n1. Create FastAPI application in `app/main.py`:\n   - Initialize FastAPI app with proper metadata\n   - Configure CORS middleware if needed\n   - Set up application lifecycle events\n2. Install and configure pymongo for MongoDB in `app/db/mongo.py`:\n   - Implement `get_db()` function to get database instance\n   - Implement `get_database_name() -> str` function\n   - Set up MongoDB connection using connection string\n   - Implement connection pooling for performance\n   - Handle connection errors gracefully\n3. Create environment configuration loader in `app/settings.py`:\n   - Implement `get_env(key: str) -> str` function\n   - Implement `require_env(key: str) -> str` function\n   - Use python-dotenv to load environment variables\n   - Define required variables: GITHUB_TOKEN, LLM_API_KEY, LLM_BASE_URL, MONGODB_URL, WEBHOOK_SECRET\n   - Implement validation for required environment variables\n4. Add health check endpoint:\n   - Create `/health` endpoint that returns status\n   - Verify MongoDB connectivity in health check\n   - Return appropriate status codes\n\n**Acceptance Criteria:**\n- FastAPI server starts successfully without errors\n- MongoDB connection is established with connection pooling\n- Environment variables are loaded correctly from .env file\n- Health check endpoint returns 200 with JSON containing status: \"ok\" when MongoDB is connected\n- Health check endpoint returns appropriate error when MongoDB is unavailable\n\nNote: /health response body must include status: \"ok\" when healthy.",
    "subtask2": "Query:\n**Subtask 2: Database Schema and Index Management**\n\nImplement database collections and indexes for agent operations:\n\n1. Create `agent_sessions` collection schema in `app/db/mongo.py`:\n   - Define document structure with fields: session_id, repository, issue_number, status, created_at, updated_at\n   - Implement session_id as unique identifier\n   - Create compound unique index on (repository, issue_number)\n   - Add index on status field for querying\n2. Create `agent_logs` collection schema:\n   - Define document structure with fields: session_id, level, message, source, timestamp\n   - Add index on session_id for efficient log retrieval\n   - Add index on timestamp for time-based queries\n3. Implement index initialization function:\n   - Implement `init_indexes() -> None` function in `app/db/mongo.py`\n   - Create indexes on application startup\n   - Handle index creation errors gracefully\n   - Ensure idempotent index creation\n4. Create database utility functions:\n   - Function to get database instance\n   - Function to get collection instances\n   - Proper error handling for database operations\n\n**Acceptance Criteria:**\n- Database collections are created with correct schema\n- Unique indexes are enforced on session_id and (repository, issue_number)\n- Indexes on status, session_id, and timestamp are created\n- Index initialization is idempotent (can run multiple times safely)\n- Database utility functions return correct collection instances\n\nNote: `app/db/mongo.py` must export `init_indexes` (and required helpers) so imports in tests succeed.",
    "subtask3": "Query:\n**Subtask 3: GitHub Webhook Endpoint and Signature Verification**\n\nBuild the webhook receiver with security validation:\n\n1. Create webhook endpoint in `app/webhooks/github.py`:\n   - Create FastAPI `router` with prefix `/webhooks`\n   - Create POST endpoint `/webhooks/github`\n   - Accept POST requests with JSON payloads\n   - Extract event type from `X-GitHub-Event` header\n   - Handle different content types appropriately\n2. Implement GitHub webhook signature verification:\n   - Extract signature from `X-Hub-Signature-256` header\n   - Compute HMAC SHA256 using WEBHOOK_SECRET\n   - Compare computed signature with provided signature\n   - Reject requests with invalid signatures (return 401)\n3. Handle webhook ping events:\n   - Process `ping` events for webhook setup verification\n   - Return appropriate response for ping events\n   - Log ping events for debugging\n4. Add request validation:\n   - Validate JSON payload format\n   - Handle malformed JSON gracefully (return 400)\n   - Log validation errors\n\n**Acceptance Criteria:**\n- Webhook endpoint accepts POST requests at `/webhooks/github`\n- Signature verification correctly validates valid requests\n- Invalid signatures are rejected with 401 status code\n- Ping events are handled and return 200 status\n- Malformed JSON payloads return 400 with error message\n- All webhook requests are logged appropriately\n\nNote: ensure FastAPI registers the `/webhooks/github` route (e.g., include router in `app.main`) so POST requests reach the handler.",
    "subtask4": "Query:\n**Subtask 4: Webhook Event Processing and Session Management**\n\nProcess GitHub webhook events and manage agent sessions:\n\n1. Process `issues.assigned` events in `app/webhooks/github.py`:\n   - Extract repository full name from payload\n   - Extract issue number and details (title, body)\n   - Call `create_or_get_session(repository: str, issue_number: int) -> str` from `app/sessions/service.py`\n   - Call `update_issue_info(session_id: str, issue_title: str, issue_body: str) -> None` to store issue details\n   - Log webhook receipt with session_id\n2. Process `issue_comment.created` events:\n   - Extract comment body and check for @mentions\n   - Detect mentions to agent user (e.g., @test-bot)\n   - Extract repository and issue number from payload\n   - Link comment to existing session or create new one\n   - Store comment content in session\n3. Implement session CRUD operations in `app/sessions/service.py`:\n   - Implement `create_or_get_session(repository: str, issue_number: int) -> str` function\n   - Implement `update_session_status(session_id: str, status: str) -> None` function\n   - Implement `update_issue_info(session_id: str, issue_title: str, issue_body: str) -> None` function\n   - Create session with unique session_id\n   - Retrieve session by session_id or (repository, issue_number)\n   - Update session status and metadata\n   - Query sessions by status or repository\n4. Add background task queue in `app/webhooks/github.py`:\n   - Use FastAPI `BackgroundTasks` parameter in webhook endpoint\n   - Queue webhook processing tasks asynchronously\n   - Return 200 immediately after queuing\n   - Process tasks in background to avoid timeout\n\n**Acceptance Criteria:**\n- `issues.assigned` events create or retrieve sessions correctly\n- Issue title and body are stored in session document\n- `issue_comment.created` events detect @mentions correctly\n- Comments are linked to correct sessions\n- Session CRUD operations work for all operations\n- Background tasks are queued and processed asynchronously\n- All events are logged with appropriate details\n\nNote: provide `app.sessions` package (e.g., `app/sessions/service.py`) with CRUD functions importable by tests.",
    "subtask5": "Query:\n**Subtask 5: GitHub CLI Integration and Logging Service**\n\nIntegrate GitHub CLI operations and implement structured logging:\n\n1. Create GitHub CLI wrapper service in `app/github/cli.py`:\n   - Use subprocess to execute `gh` commands\n   - Authenticate using GITHUB_TOKEN environment variable\n   - Implement error handling for CLI failures\n2. Implement GitHub CLI functions in `app/github/cli.py`:\n   - Implement `clone_repository(repository: str, target_dir: Optional[str] = None) -> str` function\n   - Implement `create_branch(repository: str, branch_name: str, base: str = \"main\") -> None` function\n   - Implement `create_pr(repository: str, title: str, body: str, head: str, base: str = \"main\") -> None` function\n   - Implement `comment_issue(repository: str, issue_number: int, body: str) -> None` function (also called `post_comment`)\n3. Implement logging service:\n   - Create `app/logs/models.py` with `AgentLog` type definition\n   - Implement `write_log(entry: AgentLog) -> None` function in `app/logs/db_logger.py`\n   - Write structured log entries to MongoDB\n   - Support log levels: info, debug, error, warning\n   - Include session_id, timestamp, source in each log entry\n   - Implement log retrieval by session_id\n4. Add logging to webhook processing:\n   - Log webhook receipt with event type\n   - Log session creation and updates\n   - Log GitHub CLI operations\n   - Log errors with full context\n\n**Acceptance Criteria:**\n- GitHub CLI commands execute successfully with GITHUB_TOKEN\n- Repository cloning works correctly\n- Branch creation and PR creation functions work\n- Comments can be posted to issues\n- Log entries are written to MongoDB with correct structure\n- Logs can be retrieved by session_id\n- All major operations are logged appropriately\n- Error logging includes full context and tracebacks"
}